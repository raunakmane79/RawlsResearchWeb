<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rawls Research Productivity</title>
  <meta name="theme-color" content="#CC0000" />

  <style>
    :root{
      /* TTU-ish theme */
      --ttu-scarlet:#CC0000;
      --ttu-dark:#111827;
      --ttu-ink:#0b1220;
      --muted:#667085;
      --border: rgba(17, 24, 39, 0.12);

      --card: rgba(255,255,255,0.92);
      --shadow: 0 18px 44px rgba(17, 24, 39, 0.14);
      --radius: 18px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ttu-ink);
      background:
        radial-gradient(900px 420px at 14% -10%, rgba(204,0,0,0.16), transparent 60%),
        radial-gradient(900px 420px at 90% 0%, rgba(17,24,39,0.12), transparent 55%),
        linear-gradient(180deg, #f7f7fb, #eef2ff 50%, #f7f7fb);
      min-height:100vh;
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(17,24,39,0.88);
      border-bottom: 3px solid var(--ttu-scarlet);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color:#fff;
    }
    .topbar-inner{
      max-width: 1160px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      line-height:1.1;
    }
    .mark{
      width:12px;
      height:34px;
      border-radius: 999px;
      background: var(--ttu-scarlet);
      box-shadow: 0 8px 18px rgba(204,0,0,0.35);
    }
    .brand strong{font-size:16px; letter-spacing:0.2px;}
    .brand span{display:block; font-size:12px; color: rgba(255,255,255,0.74); margin-top:2px;}

    .nav a{
      color:#fff;
      text-decoration:none;
      font-weight: 800;
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      display:inline-block;
    }
    .nav a:hover{background: rgba(255,255,255,0.10);}
    .nav a.active{
      background: rgba(204,0,0,0.18);
      border: 1px solid rgba(204,0,0,0.55);
    }

    /* Layout */
    .wrap{
      max-width: 1160px;
      margin: 0 auto;
      padding: 22px 16px 34px;
    }

    .hero{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      margin: 10px 0 18px;
    }
    .hero h1{
      margin:0;
      font-size: 30px;
      letter-spacing: -0.3px;
    }
    .hero p{
      margin: 6px 0 0;
      max-width: 820px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .pill{
      background: rgba(255,255,255,0.78);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 13px;
      color: var(--muted);
      box-shadow: 0 6px 18px rgba(17,24,39,0.08);
      white-space: nowrap;
    }

    .controls{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      appearance:none;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.92);
      color: var(--ttu-ink);
      box-shadow: 0 6px 18px rgba(17,24,39,0.08);
      transition: transform .06s ease, filter .15s ease;
    }
    button:active{transform: translateY(1px);}
    button.primary{
      background: linear-gradient(135deg, rgba(204,0,0,0.92), rgba(204,0,0,0.72));
      color:#fff;
      border: 1px solid rgba(204,0,0,0.55);
    }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 16px;
    }
    @media (max-width: 1020px){
      .grid{grid-template-columns: 1fr;}
      .hero{flex-direction:column; align-items:flex-start;}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(760px 240px at 18% 0%, rgba(204,0,0,0.08), transparent 62%);
      pointer-events:none;
    }
    .card > *{position:relative;}

    .card h2{
      margin:0 0 6px;
      font-size: 16px;
      font-weight: 950;
      display:flex;
      align-items:center;
      gap:10px;
      letter-spacing:-0.1px;
    }
    .badge{
      font-size: 12px;
      font-weight: 950;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.85);
    }
    .sub{
      margin:0 0 10px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .chartBox{height: 340px; position:relative;}

    .footer-note{
      margin-top: 14px;
      color: var(--muted);
      font-size: 13px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(17,24,39,0.16);
      background: rgba(255,255,255,0.68);
      box-shadow: 0 6px 18px rgba(17,24,39,0.06);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="mark"></div>
        <div>
          <strong>Rawls Faculty Publications</strong>
          <span>Research Productivity</span>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a class="active" href="rrp.html">Rawls Research Productivity</a>
        <a href="about.html">About</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="hero">
      <div>
        <h1>Rawls Research Productivity</h1>
        <p>Publication counts by Area across key categories.</p>

        <div class="meta">
          <div class="controls">
            <button class="primary" id="refreshBtn">Refresh</button>
          </div>
          <div class="pill" id="lastUpdated">Updating…</div>
        </div>
      </div>
    </div>

    <section class="grid">
      <div class="card">
        <h2><span class="badge">5*</span> 5* Publications by Area</h2>
        <p class="sub">Count by Area</p>
        <div class="chartBox"><canvas id="chart5star"></canvas></div>
      </div>

      <div class="card">
        <h2><span class="badge">5</span> 5 Publications by Area</h2>
        <p class="sub">Count by Area</p>
        <div class="chartBox"><canvas id="chart5"></canvas></div>
      </div>

      <div class="card">
        <h2><span class="badge">UTD</span> UTD Publications by Area</h2>
        <p class="sub">Count by Area</p>
        <div class="chartBox"><canvas id="chartUTD"></canvas></div>
      </div>

      <div class="card">
        <h2><span class="badge">FT</span> Financial Times Publications by Area</h2>
        <p class="sub">Count by Area</p>
        <div class="chartBox"><canvas id="chartFT"></canvas></div>
      </div>
    </section>

    <div class="footer-note" id="rrpStatus">Updating…</div>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ====== CONFIG ======
    const EXCEL_FILE = "Database.xlsx"; // change if your filename differs
    const SHEET_NAME = "12";

    // Professional, muted palette (consistent across all charts)
    // (Not neon, not overly bright; works well on TTU-themed UI)
    const PROFESSIONAL_AREA_COLORS = [
      "#1F2937", // slate
      "#374151", // graphite
      "#475569", // steel
      "#0F766E", // deep teal
      "#155E75", // deep cyan/blue
      "#1D4ED8", // mature blue
      "#4F46E5", // indigo
      "#6D28D9", // deep purple
      "#9A3412", // warm brown
      "#B45309", // amber-brown
      "#7F1D1D", // maroon
      "#9F1239"  // wine
    ];

    const charts = {};

    function cleanStr(v){ return (v ?? "").toString().trim(); }
    function yes(v){ return cleanStr(v).toLowerCase() === "yes"; }

    function hashString(str){
      let h = 2166136261;
      for (let i = 0; i < str.length; i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }

    function hexToRgba(hex, a){
      const h = hex.replace("#","");
      const r = parseInt(h.slice(0,2),16);
      const g = parseInt(h.slice(2,4),16);
      const b = parseInt(h.slice(4,6),16);
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }

    function wrapLabel(label, maxLineLen = 14){
      const s = cleanStr(label);
      if (s.length <= maxLineLen) return s;

      const words = s.split(/\s+/);
      const lines = [];
      let line = "";

      for (const w of words){
        const test = line ? (line + " " + w) : w;
        if (test.length > maxLineLen){
          if (line) lines.push(line);
          line = w;
        } else {
          line = test;
        }
      }
      if (line) lines.push(line);

      if (lines.length === 1 && lines[0].length > maxLineLen){
        const hard = [];
        let t = lines[0];
        while (t.length > maxLineLen){
          hard.push(t.slice(0, maxLineLen));
          t = t.slice(maxLineLen);
        }
        if (t) hard.push(t);
        return hard;
      }

      return lines;
    }

    // Stable Area -> Color mapping (same Area always same color)
    function buildAreaColorMap(areaLabels){
      const map = {};
      for (const area of areaLabels){
        const idx = hashString(area) % PROFESSIONAL_AREA_COLORS.length;
        const base = PROFESSIONAL_AREA_COLORS[idx];

        map[area] = {
          border: base,
          fill: hexToRgba(base, 0.48),
          fillHover: hexToRgba(base, 0.66)
        };
      }
      return map;
    }

    function destroy(key){
      if (charts[key]) { charts[key].destroy(); delete charts[key]; }
    }

    function buildBar(canvasId, labels, values, key, areaColorMap){
      const el = document.getElementById(canvasId);
      if (!el) return;

      destroy(key);

      const bg = labels.map(a => areaColorMap[a].fill);
      const bd = labels.map(a => areaColorMap[a].border);
      const hoverBg = labels.map(a => areaColorMap[a].fillHover);

      charts[key] = new Chart(el, {
        type: "bar",
        data: {
          labels: labels.map(l => wrapLabel(l, 14)),
          datasets: [{
            label: "Count",
            data: values,
            backgroundColor: bg,
            borderColor: bd,
            hoverBackgroundColor: hoverBg,
            borderWidth: 2,
            borderRadius: 12,
            barThickness: 44,
            maxBarThickness: 56
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 650, easing: "easeOutQuart" },
          layout: { padding: { left: 8, right: 8, top: 10, bottom: 0 } },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                title: (items) => {
                  const idx = items[0].dataIndex;
                  return labels[idx]; // full label (not wrapped)
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                autoSkip: false,
                maxRotation: 0,
                minRotation: 0,
                font: { size: 11, weight: "800" },
                color: "rgba(11, 18, 32, 0.70)"
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                font: { weight: "800" },
                color: "rgba(11, 18, 32, 0.60)"
              },
              grid: { color: "rgba(11,18,32,0.08)" }
            }
          }
        }
      });
    }

    async function loadExcelAndRender(){
      const status = document.getElementById("rrpStatus");
      const pill = document.getElementById("lastUpdated");

      status.textContent = "Updating…";

      try{
        const url = `${EXCEL_FILE}?v=${Date.now()}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Unavailable");

        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array" });

        const sheet = wb.Sheets[SHEET_NAME];
        if (!sheet) throw new Error("Unavailable");

        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        const byArea = {};
        for (const r of rows){
          const area = cleanStr(r["Area"]);
          if (!area) continue;

          if (!byArea[area]) byArea[area] = { fiveStar:0, five:0, utd:0, ft:0 };

          const ranking = cleanStr(r["Ranking - Updated"]);
          if (ranking === "5*") byArea[area].fiveStar++;
          if (ranking === "5")  byArea[area].five++;

          if (yes(r["UTD Journal"])) byArea[area].utd++;
          if (yes(r["Financial Times Journal"])) byArea[area].ft++;
        }

        // One consistent Area ordering across all charts
        const areas = Object.keys(byArea).sort((a,b) => {
          const ta = byArea[a].fiveStar + byArea[a].five + byArea[a].utd + byArea[a].ft;
          const tb = byArea[b].fiveStar + byArea[b].five + byArea[b].utd + byArea[b].ft;
          return tb - ta;
        });

        const areaColorMap = buildAreaColorMap(areas);

        buildBar("chart5star", areas, areas.map(a => byArea[a].fiveStar), "fiveStar", areaColorMap);
        buildBar("chart5",     areas, areas.map(a => byArea[a].five),     "five",     areaColorMap);
        buildBar("chartUTD",   areas, areas.map(a => byArea[a].utd),      "utd",      areaColorMap);
        buildBar("chartFT",    areas, areas.map(a => byArea[a].ft),       "ft",       areaColorMap);

        const now = new Date();
        pill.textContent = `Last updated: ${now.toLocaleString()}`;
        status.textContent = "—";

      }catch(e){
        console.error(e);
        status.textContent = "Charts are temporarily unavailable. Please try again.";
        pill.textContent = "—";
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", loadExcelAndRender);
    document.addEventListener("DOMContentLoaded", loadExcelAndRender);
  </script>
</body>
</html>
